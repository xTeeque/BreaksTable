<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>דשבורד</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body data-role="<%= user?.role || 'user' %>">
  <div class="card" style="max-width:960px">
    <div class="topbar">
      <% if (user && user.role === 'admin') { %>
        <button id="btn-clear-all" class="badge danger" style="margin-inline-start:8px">ניקוי כללי</button>
        <form id="add-slot-form" class="inline" method="post" action="/admin/slots/create" style="display:inline-flex; gap:6px; align-items:center; margin-inline-start:8px">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input name="label" placeholder="טקסט בתא (לא חובה)" style="width:140px">
          <input name="time_label" placeholder="שעה (HH:MM)" required pattern="^\\d{2}:\\d{2}$" style="width:110px">
          <input name="col_index" placeholder="עמודה (1-4)" type="number" min="1" max="4" required style="width:90px">
          <input name="row_index" placeholder="שורה" type="number" min="0" required style="width:80px">
          <input type="hidden" name="color" value="#e5e7eb">
          <input type="hidden" name="active" value="true">
          <button class="badge" type="submit">הוסף משבצת</button>
        </form>
      <% } %>

      <h1>שלום <%= (user?.first_name || "") + " " + (user?.last_name || "") %></h1>
      <form method="post" action="/logout">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit">התנתקות</button>
      </form>
    </div>
    <p class="muted">
      כל שורה = שעה מימין + 4 משבצות משמאל. ברירת מחדל: 2 פתוחות + 2 סגורות. רק משבצת תפוסה נצבעת בירוק.
      (אדמין: פתיחה/סגירה/ניקוי/עריכת שם/עריכת שעה/מחיקה)
    </p>

    <div id="grid" class="grid">
      <%
        const HOURS = ["12:50","13:25","14:00","14:35"];

        // קיבוץ לפי שעה
        const byHour = {};
        slots.forEach(s => {
          if (!byHour[s.time_label]) byHour[s.time_label] = [];
          byHour[s.time_label].push(s);
        });

        function fourFor(t) {
          const arr = (byHour[t] || []).slice().sort((a,b) => {
            if (a.row_index !== b.row_index) return a.row_index - b.row_index;
            return a.col_index - b.col_index;
          });
          // אם אין בדיוק 4, נשלים/נחתוך ויזואלית (הנתונים עצמם נשמרים בבסיס)
          while (arr.length < 4) arr.push({
            slot_id: -1,
            label: '',
            color: '#e0f2fe',
            time_label: t,
            col_index: arr.length+1,
            row_index: 0,
            active: false,
            user_id: null
          });
          return arr.slice(0,4);
        }
      %>

      <% HOURS.forEach(time => {
           const cells = fourFor(time);
      %>
        <!-- תא שעה מימין -->
        <div class="cell time"><%= time %></div>

        <!-- 4 משבצות משמאל -->
        <% cells.forEach(s => {
             const taken = !!s.user_id;
             const mine  = s.user_id && user && s.user_id === user.id;
             const showName = taken || (user && user.role==='admin' && s.label);
             const bg = taken ? '#86efac' : '#e0f2fe';
             const disabledForUser = (!s.active || (taken && !mine));
        %>
          <div class="cell <%= mine ? 'mine' : '' %> <%= disabledForUser ? 'disabled' : '' %>"
               style="background:<%= bg %>"
               data-slot-id="<%= s.slot_id %>"
               data-taken="<%= taken ? '1' : '0' %>"
               data-mine="<%= mine ? '1' : '0' %>"
               data-active="<%= s.active ? '1' : '0' %>">
            <div class="slot-text"><%= showName ? (s.label || '') : '' %></div>
            <div class="badge">
              <% if (mine) { %>שלך (הסר)
              <% } else if (!s.active) { %>סגור
              <% } else if (taken) { %>תפוס
              <% } else { %>פנוי<% } %>
            </div>

            <% if (user && user.role==='admin') { %>
              <div class="admin-actions">
                <span class="badge" data-action="clear">נקה</span>
                <% if (s.active) { %>
                  <span class="badge danger" data-action="close">סגור</span>
                <% } else { %>
                  <span class="badge success" data-action="open">פתח</span>
                <% } %>
                <span class="badge info" data-action="label">ערוך שם</span>
                <span class="badge" data-action="time">ערוך שעה</span>
                <form class="inline" data-action="delete" style="display:inline">
                  <input type="hidden" name="slot_id" value="<%= s.slot_id %>">
                  <button class="badge danger" type="submit">מחק</button>
                </form>
              </div>
            <% } %>
          </div>
        <% }) %>
      <% }) %>
    </div>
  </div>

    <script>window.CSRF_TOKEN = "<%= csrfToken %>"</script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/dashboard.js" defer></script>
</body>
</html>
