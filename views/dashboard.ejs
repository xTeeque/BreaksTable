<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>דשבורד</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body data-role="<%= user?.role || 'user' %>">
  <div class="card" style="max-width:960px">
    <div class="topbar">
      <h1>שלום <%= (user?.first_name || "") + " " + (user?.last_name || "") %></h1>
      <div class="actions" style="display:flex; gap:8px; align-items:center;">
        <% if (user && user.role === 'admin') { %>
          <button id="btn-clear-all" type="button" class="btn danger">ניקוי כללי</button>
          <button id="btn-hour-add" type="button" class="btn">הוסף שעה</button>
        <% } %>
        <form method="post" action="/logout" style="margin:0">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <button type="submit">התנתקות</button>
        </form>
      </div>
    </div>

    <p class="muted">
      כל שורה = שעה מימין + 4 משבצות משמאל. ברירת מחדל: 2 פתוחות + 2 סגורות. משבצת תפוסה או כזו שהאדמין כתב בה שם — נצבעת בירוק.
    </p>

    <div id="grid" class="grid">
      <%
        // קיבוץ לפי שעה
        const grouped = {};
        (slots || []).forEach(s => {
          const k = s.time_label;
          if (!grouped[k]) grouped[k] = [];
          grouped[k].push(s);
        });

        // מיון שעות כרונולוגי HH:mm
        const hours = Object.keys(grouped)
          .filter(Boolean)
          .sort((a,b)=>{
            const [ah,am]=a.split(':').map(Number); const [bh,bm]=b.split(':').map(Number);
            return (ah*60+am)-(bh*60+bm);
          });
      %>

      <% hours.forEach(time => {
           const cells = (grouped[time] || [])
             .filter(s => s.col_index >= 1 && s.col_index <= 4)
             .sort((a,b) => (a.col_index||0) - (b.col_index||0))
             .slice(0, 4);
      %>
        <!-- תא שעה מימין -->
        <div class="cell time">
          <div><%= time %></div>
          <% if (user && user.role==='admin') { %>
            <div class="admin-actions" style="margin-top:6px">
              <span class="badge info" data-action="hour-rename" data-time="<%= time %>">שנה שעה</span>
              <span class="badge danger" data-action="hour-delete" data-time="<%= time %>">מחק שעה</span>
            </div>
          <% } %>
        </div>

        <!-- 4 משבצות משמאל -->
        <% cells.forEach(s => {
             const taken = !!s.user_id;
             const mine  = s.user_id && user && s.user_id === user.id;

             // מציגים שם תמיד אם יש label (כולל “שם שאדמין כתב”), גם בלי reservation
             const showName = !!(s.label && s.label.trim());

             // ירוק אם תפוס או אם לאדמין יש label; אחרת תכלת
             const bg = (taken || showName) ? '#86efac' : '#e0f2fe';

             // משתמש רגיל לא יכול ללחוץ על סגור/תפוס; אדמין כן
             const disabledForUser = (!s.active || (taken && !mine));
        %>
          <div class="cell <%= mine ? 'mine' : '' %> <%= disabledForUser ? 'disabled' : '' %>"
               style="background:<%= bg %>"
               data-slot-id="<%= s.slot_id %>"
               data-taken="<%= taken ? '1' : '0' %>"
               data-mine="<%= mine ? '1' : '0' %>"
               data-active="<%= s.active ? '1' : '0' %>">
            <div class="slot-text"><%= showName ? (s.label || '') : '' %></div>
            <div class="badge">
              <% if (mine) { %>שלך (הסר)
              <% } else if (!s.active) { %>סגור
              <% } else if (taken || showName) { %>תפוס
              <% } else { %>פנוי<% } %>
            </div>

            <% if (user && user.role === 'admin') { %>
              <div class="admin-actions">
                <span class="badge" data-action="clear">נקה</span>
                <% if (s.active) { %>
                  <span class="badge danger" data-action="close">סגור</span>
                <% } else { %>
                  <span class="badge success" data-action="open">פתח</span>
                <% } %>
                <span class="badge info" data-action="label">ערוך שם</span>
              </div>
            <% } %>
          </div>
        <% }) %>
      <% }) %>
    </div>
  </div>

  <script>window.CSRF_TOKEN = "<%= csrfToken %>"</script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/dashboard.js" defer></script>
</body>
</html>
