<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>דשבורד</title>
  <link rel="stylesheet" href="/style.css">
  <!-- חשוב: כדי שה- JS יוכל לשלוח POST עם CSRF -->
  <meta name="csrf-token" content="<%= csrfToken %>">
  <style>
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin:12px auto; max-width:1100px; }
    .topbar .left, .topbar .right { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .grid { width:100%; max-width:1100px; margin:0 auto; border-collapse:separate; border-spacing:8px; }
    .grid th, .grid td { vertical-align:top; }
    .hour-cell { display:flex; align-items:center; gap:8px; }
    .admin-controls { margin-top:6px; display:flex; gap:6px; flex-wrap:wrap; justify-content:center; }
    .slot { min-width:150px; min-height:64px; border:1px solid #e5e7eb; border-radius:10px; padding:8px; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.04); display:flex; flex-direction:column; justify-content:space-between; }
    .slot .label { padding:6px 8px; border-radius:8px; min-height:28px; display:flex; align-items:center; justify-content:center; font-weight:600; }
    .badge { cursor:pointer; }
    .chk { display:flex; align-items:center; gap:6px; }
    .muted { color:#6b7280; }
  </style>
</head>
<body>

  <div class="card topbar">
    <div class="right">
      <span>שלום, <strong><%= [user?.first_name || "", user?.last_name || ""].join(" ").trim() %></strong></span>
      <button class="badge" data-action="unreserve">שחרר את המשבצת שלי</button>
    </div>
    <div class="left">
      <% if (user && user.role === 'admin') { %>
        <button class="badge" data-action="create-hour">הוסף שעה</button>
        <button class="badge" data-action="cleanup">ניקוי כללי</button>
      <% } %>
      <a class="badge" href="/profile">פרופיל</a>
      <form method="post" action="/logout" class="inline">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit" class="badge">התנתקות</button>
      </form>
    </div>
  </div>

  <% /* קיבוץ משבצות לפי שעה */ %>
  <% const byTime = {}; for (const s of (slots || [])) { (byTime[s.time_label] || (byTime[s.time_label]=[])).push(s); } %>
  <% const times = Object.keys(byTime).sort(); %>

  <table class="grid">
    <thead>
      <tr>
        <th>שעה</th>
        <th>עמודה 1</th>
        <th>עמודה 2</th>
        <th>עמודה 3</th>
        <th>עמודה 4</th>
      </tr>
    </thead>
    <tbody>
      <% times.forEach(function (tl) { 
           const row = byTime[tl]; 
           const byCol = {}; row.forEach(s => byCol[s.col_index] = s);
      %>
      <tr data-time="<%= tl %>">
        <th>
          <div class="hour-cell">
            <span class="tl" style="font-weight:700"><%= tl %></span>
            <% if (user && user.role === 'admin') { %>
              <div class="admin-controls">
                <button class="badge" data-action="rename-hour" data-time="<%= tl %>">ערוך שעה</button>
                <button class="badge danger" data-action="delete-hour" data-time="<%= tl %>">הסר שעה</button>
              </div>
            <% } %>
          </div>
        </th>

        <% for (let c=1; c<=4; c++) { 
             const s = byCol[c];
             if (s) { %>
          <td>
            <!-- לחיצה על הקופסה עצמה תרשום יוזר (אם לא בתוך אזור אדמין) -->
            <div class="slot" data-slot-id="<%= s.id %>" data-time="<%= tl %>">
              <div class="label" style="background:<%= s.color || '#e5e7eb' %>">
                <%= (s.label || '').trim() %>
              </div>

              <% if (user && user.role === 'admin') { %>
                <div class="admin-controls">
                  <label class="chk">
                    <input type="checkbox"
                           data-slot-id="<%= s.id %>"
                           data-action="toggle-active"
                           <%= s.active ? 'checked' : '' %> >
                    פתוחה
                  </label>
                  <button class="badge" data-action="set-label" data-slot-id="<%= s.id %>">קבע תווית</button>
                  <button class="badge gray" data-action="clear-slot" data-slot-id="<%= s.id %>">סגור/נקה</button>
                </div>
              <% } %>
            </div>
          </td>
        <% } else { %>
          <td><div class="slot muted">—</div></td>
        <% } } %>
      </tr>
      <% }) %>
    </tbody>
  </table>

  <!-- זמין לסקריפט גם אם לא קראת את ה-meta -->
  <script>window.CSRF_TOKEN = "<%= csrfToken %>";</script>
  <script src="/dashboard.js" defer></script>
</body>
</html>
