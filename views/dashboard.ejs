<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>דשבורד</title>
  <link rel="stylesheet" href="/style.css">
  <!-- מאפשר ל-JS לשלוח POST מבלי לשבור את העיצוב -->
  <meta name="csrf-token" content="<%= csrfToken %>">
</head>
<body>

  <!-- כותרת עליונה כפי שהיה: שם משתמש מימין; משמאל כפתורי אדמין + פרופיל/התנתקות -->
  <div class="card topbar">
    <div class="right">
      <span>שלום, <strong><%= [user?.first_name || "", user?.last_name || ""].join(" ").trim() %></strong></span>
      <button class="badge" data-action="unreserve">שחרר את המשבצת שלי</button>
    </div>
    <div class="left">
      <% if (user && user.role === 'admin') { %>
        <button class="badge" data-action="create-hour">הוסף שעה</button>
        <button class="badge" data-action="cleanup">ניקוי כללי</button>
      <% } %>
      <a class="badge" href="/profile">פרופיל</a>
      <form method="post" action="/logout" class="inline">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit" class="badge">התנתקות</button>
      </form>
    </div>
  </div>

  <% /* קיבוץ משבצות לפי שעה (לוגיקת EJS בלבד, אין שינוי ויזואלי) */ %>
  <% const byTime = {}; for (const s of (slots || [])) { (byTime[s.time_label] || (byTime[s.time_label]=[])).push(s); } %>
  <% const times = Object.keys(byTime).sort(); %>

  <table class="grid">
    <thead>
      <tr>
        <th>שעה</th>
        <th>עמודה 1</th>
        <th>עמודה 2</th>
        <th>עמודה 3</th>
        <th>עמודה 4</th>
      </tr>
    </thead>
    <tbody>
      <% times.forEach(function (tl) { 
           const row = byTime[tl]; 
           const byCol = {}; row.forEach(s => byCol[s.col_index] = s);
      %>
      <tr data-time="<%= tl %>">
        <th>
          <div class="hour">
            <span class="time-label"><%= tl %></span>
            <% if (user && user.role === 'admin') { %>
              <!-- כפתורי אדמין לשעה עצמה (בלתי-נראה לשאר) -->
              <button class="badge" data-action="rename-hour" data-time="<%= tl %>">ערוך שעה</button>
              <button class="badge danger" data-action="delete-hour" data-time="<%= tl %>">הסר שעה</button>
            <% } %>
          </div>
        </th>

        <% for (let c=1; c<=4; c++) { 
             const s = byCol[c];
             if (s) { %>
          <td>
            <!-- לא משנים את המבנה הויזואלי; רק מוסיפים data-slot-id כדי שלחיצה תעבוד -->
            <div class="slot" data-slot-id="<%= s.id %>" data-time="<%= tl %>">
              <div class="label" style="background:<%= s.color || '#e5e7eb' %>">
                <%= (s.label || '').trim() %>
              </div>

              <% if (user && user.role === 'admin') { %>
                <!-- פקדי אדמין בתוך המשבצת (כמו שהיה, בלי שינוי סגנון) -->
                <label class="inline">
                  <input type="checkbox"
                         data-slot-id="<%= s.id %>"
                         data-action="toggle-active"
                         <%= s.active ? 'checked' : '' %> >
                  פתוחה
                </label>
                <button class="badge" data-action="set-label" data-slot-id="<%= s.id %>">קבע תווית</button>
                <button class="badge gray" data-action="clear-slot" data-slot-id="<%= s.id %>">סגור/נקה</button>
              <% } %>
            </div>
          </td>
        <% } else { %>
          <td><div class="slot muted">—</div></td>
        <% } } %>
      </tr>
      <% }) %>
    </tbody>
  </table>

  <!-- מאפשר חלופה אם ה-meta לא נקרא -->
  <script>window.CSRF_TOKEN = "<%= csrfToken %>";</script>
  <script src="/dashboard.js" defer></script>
</body>
</html>
