<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>דשבורד</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body data-role="<%= user?.role || 'user' %>">
  <div class="card">
    <div class="topbar">
      <h1>שלום <%= (user?.first_name || "") + " " + (user?.last_name || "") %></h1>
      <form method="post" action="/logout">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit">התנתקות</button>
      </form>
    </div>
    <p class="muted">לחיצה על משבצת פנויה תרשום אותך; אפשר רק משבצת אחת. לחיצה על משבצת שלך תסיר.</p>

    <div id="grid" class="grid">
      <% slots.forEach(s => { 
           const taken = !!s.user_id;
           const mine = s.user_id && user && s.user_id === user.id;
           const isTime = s.is_time;
           const bg = taken ? '#86efac' : s.color; // ירוק כשנתפס
           const disabled = (!isTime && (!s.active || (taken && !mine)));
      %>
        <div class="cell <%= isTime ? 'time' : '' %> <%= mine ? 'mine' : '' %> <%= disabled ? 'disabled' : '' %>"
             style="background:<%= bg %>"
             data-slot-id="<%= s.slot_id %>"
             data-is-time="<%= isTime ? '1' : '0' %>"
             data-taken="<%= taken ? '1' : '0' %>"
             data-mine="<%= mine ? '1' : '0' %>"
             data-active="<%= s.active ? '1' : '0' %>">
          <% if (isTime) { %>
            <div><%= s.time_label %></div>
          <% } else { %>
            <div><%= taken ? (s.label || '') : '' %></div>
            <div class="badge">
              <% if (mine) { %>שלך (הסר)
              <% } else if (!s.active) { %>סגור
              <% } else if (taken) { %>תפוס
              <% } else { %>פנוי<% } %>
            </div>
            <% if (user && user.role === 'admin') { %>
              <div style="margin-top:6px; display:flex; gap:6px; justify-content:center;">
                <span class="badge" data-action="clear" style="background:#111;color:#fff;">נקה</span>
                <% if (s.active) { %>
                  <span class="badge" data-action="close" style="background:#b91c1c;color:#fff;">סגור</span>
                <% } else { %>
                  <span class="badge" data-action="open" style="background:#16a34a;color:#fff;">פתח</span>
                <% } %>
              </div>
            <% } %>
          <% } %>
        </div>
      <% }) %>
    </div>
  </div>

  <script>window.CSRF_TOKEN = "<%= csrfToken %>"</script>
  <script src="/dashboard.js"></script>
</body>
</html>
