<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>דשבורד</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body data-role="<%= (typeof user !== 'undefined' && user && user.role) ? user.role : 'user' %>">
  <%
    const U = (typeof user !== 'undefined' && user) ? user : {};
    const SLOTS = Array.isArray(slots) ? slots : [];
    const CSRF = (typeof csrfToken !== 'undefined' && csrfToken) ? csrfToken : '';
    const HOURS = ["12:50","13:25","14:00","14:35"];

    const byHour = {};
    SLOTS.forEach(s => {
      if (!byHour[s.time_label]) byHour[s.time_label] = [];
      byHour[s.time_label].push(s);
    });

    function fourFor(t) {
      const arr = (byHour[t] || []).slice().sort((a,b) => {
        if ((a.row_index ?? 0) !== (b.row_index ?? 0)) return (a.row_index ?? 0) - (b.row_index ?? 0);
        return (a.col_index ?? 0) - (b.col_index ?? 0);
      });
      while (arr.length < 4) arr.push({
        slot_id: -1, label: '', color: '#e0f2fe', time_label: t, col_index: arr.length+1,
        row_index: 0, active: false, user_id: null, admin_lock: false
      });
      return arr.slice(0,4);
    }
  %>

  <div class="card" style="max-width:960px">
    <div class="topbar" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <% if (U.role === 'admin') { %>
        <button id="btn-clear-all" class="badge danger">ניקוי כללי</button>
        <form id="add-slot-form" class="inline" method="post" action="/admin/slots/create" style="display:inline-flex; gap:6px; align-items:center">
          <input type="hidden" name="_csrf" value="<%= CSRF %>">
          <input name="label" placeholder="טקסט בתא (לא חובה)" style="width:140px">
          <input name="time_label" placeholder="שעה (HH:MM)" required pattern="^\\d{2}:\\d{2}$" style="width:110px">
          <input name="col_index" placeholder="עמודה (1-4)" type="number" min="1" max="4" required style="width:90px">
          <input name="row_index" placeholder="שורה" type="number" min="0" required style="width:80px">
          <input type="hidden" name="color" value="#e0f2fe">
          <input type="hidden" name="active" value="true">
          <button class="badge" type="submit">הוסף משבצת</button>
        </form>
      <% } %>

      <h1 style="margin-inline-start:auto">
        שלום <%= [U.first_name || "", U.last_name || ""].join(" ").trim() %>
      </h1>

      <form method="post" action="/logout">
        <input type="hidden" name="_csrf" value="<%= CSRF %>">
        <button type="submit">התנתקות</button>
      </form>
    </div>

    <p class="muted">
      משבצת נחשבת <strong>“תפוס”</strong> אם יש הרשמה או אם אדמין נעל אותה עם שם מותאם.
    </p>

    <div id="grid" class="grid">
      <% HOURS.forEach(time => { const cells = fourFor(time); %>
        <div class="cell time"><%= time %></div>

        <% cells.forEach(s => {
             const sid = Number(s.slot_id || -1);
             const hasUser = !!s.user_id;
             const adminLocked = !!s.admin_lock;
             const taken = hasUser || adminLocked;        // ← תפוס גם אם admin_lock=true
             const mine  = hasUser && U.id && (s.user_id === U.id);
             const active = !!s.active;
             const showName = taken ? (s.label || '') : ''; // בשם אדמין או משתמש
             const bg = taken ? '#86efac' : (s.color || '#e0f2fe');
             const disabledForUser = (!active || (taken && !mine));
        %>
          <div class="cell <%= mine ? 'mine' : '' %> <%= disabledForUser ? 'disabled' : '' %>"
               style="background:<%= bg %>"
               data-slot-id="<%= sid %>"
               data-taken="<%= taken ? '1' : '0' %>"
               data-mine="<%= mine ? '1' : '0' %>"
               data-active="<%= active ? '1' : '0' %>">

            <div class="slot-text"><%= showName %></div>
            <div class="badge">
              <% if (mine) { %>שלך (הסר)
              <% } else if (!active) { %>סגור
              <% } else if (taken) { %>תפוס
              <% } else { %>פנוי<% } %>
            </div>

            <% if (U.role === 'admin' && sid > 0) { %>
              <div class="admin-actions">
                <span class="badge" data-action="clear">נקה</span>
                <% if (active) { %>
                  <span class="badge danger" data-action="close">סגור</span>
                <% } else { %>
                  <span class="badge success" data-action="open">פתח</span>
                <% } %>
                <span class="badge info" data-action="label">ערוך שם</span>
                <span class="badge" data-action="time">ערוך שעה</span>
                <form class="inline" data-action="delete" style="display:inline">
                  <input type="hidden" name="slot_id" value="<%= sid %>">
                  <button class="badge danger" type="submit">מחק</button>
                </form>
              </div>
            <% } %>
          </div>
        <% }) %>
      <% }) %>
    </div>
  </div>

  <script>window.CSRF_TOKEN = "<%= CSRF %>"</script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/dashboard.js" defer></script>
</body>
</html>
